<html>
  <head>
    <meta lang="jp" name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Location-based AR.jsのテスト</title>
    <!-- A-Frameライブラリ -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- GPS -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <!-- カメラ -->
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <!-- パーティクル用コンポーネント読み込み -->
    <script src="https://unpkg.com/aframe-gps-entity-place@1.7.0/dist/aframe-gps-entity-place.min.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >

      <a-assets timeout="10000">
        <img id="oinari" src="./images/M-09385-0.png" title="oinari">
        <img id="kokutou" src="./images/M-09385-2.png" title="kokutou">
      </a-assets>

      <!-- おいなりさん -->
      <a-image
        src="#oinari"
        gps-entity-place="latitude: 35.704676490307065; longitude: 139.6383028910223;"
        look-at="[gps-camera]"
        scale="10 10 10"
        position="0 50 0"></a-image>

      <!-- 黒糖さん -->
      <a-image
        src="#kokutou"
        gps-entity-place="latitude: 35.70468018962566; longitude: 139.63844684828968;"
        look-at="[gps-camera]"
        scale="10 10 10"
        position="0 70 0"></a-image>

      <!-- カメラ -->
      <a-camera gps-camera rotation-reader> </a-camera>
    </a-scene>
  </body>
</html>
<script>
  // 鬼火みたいなパーティクルを自動生成する
  // const MAX_PARTICLES = 20;

  // function createRandomSphere() {
  //   const scene = document.querySelector('a-scene');
  //   const sphere = document.createElement('a-sphere');

  //   // サイズをランダムに設定
  //   const radius = Math.random() * 0.15 + 0.05;
  //   sphere.setAttribute('radius', radius);

  //   // デフォルトの位置をランダム生成
  //   const posX = Math.random() * 100;
  //   const posY = Math.random() * 100;
  //   const posZ = Math.random() * 100;
  //   sphere.setAttribute('position', `${posX} ${posY} ${posZ}`);

  //   // 色をランダムで変更
  //   // colors = [赤、黄、黄緑、水色、紫]
  //   const colors = ['#ff5e57', '#ffd32a', '#32ff7e', '#18dcff', '#7d5fff'];
  //   const color = colors[Math.floor(Math.random() * colors.length)];
  //   sphere.setAttribute('color', color);
  //   // 透過
  //   sphere.setAttribute('material', 'opacity: 0.7; transparent: true;');

  //   // 移動方向（ランダム）
  //   const toX = posX + (Math.random() * 10 - 5);
  //   const toY = posY + (Math.random() * 10 - 5);
  //   const toZ = posZ + (Math.random() * 10 - 5);
  //   sphere.setAttribute('animation', {
  //     property: 'position',
  //     to: `${toX} ${toY} ${toZ}`,
  //     dur: 5000 + Math.random() * 5000, // 5〜10秒で移動する
  //     dir: 'alternate',
  //     easing: 'easeInOutSine',
  //     loop: true
  //   });

  //   // 丸を生成
  //   sphere.setAttribute('geometry', {
  //     primitive: 'sphere',
  //     segments: 32
  //   });

  //   sphere.setAttribute('animation-mixer');
  //   scene.appendChild(sphere);
  // }

  // // 画面が読み込まれたらパーティクルを生成する
  // window.addEventListener('DOMContentLoaded', () => {
  //   for(let i = 0; i < MAX_PARTICLES; i++) {
  //     createRandomSphere();
  //   }
  // });


  const MAX_PARTICLES = 20;

  window.addEventListener('load', () => {
      const scene = document.querySelector('a-scene');
      for(let i = 0; i < MAX_PARTICLES; i++) {
        const particle = document.createElement('a-entity');

        // デフォルト位置はランダムで
        const posX = (Math.random() - 0.5) * 10;
        const posY = Math.random() * 2 + 1;
        const posZ = (Math.random() - 0.5) * 10;

        // 色もランダム生成
        const color = `hsl(${Math.random() * 360}, 100%, 70%)`;

        // サイズをランダム生成
        const size = Math.random() * 0.15 + 0.05;

        // 丸を生成
        particle.setAttribute('geometry', {
          primitive: 'sphere',
          radius: size,
          segments: 32
        });

        particle.setAttribute('position', `${posX} ${posY} ${posZ}`);
        particle.setAttribute('material', {
          color: color,
          opacity: 0.7,
          transparent: true,
          side: 'double'
        });

        // アニメーション
        const toX = posX + (Math.random() * 10 - 5);
        const toY = posY + (Math.random() * 10 - 5);
        const toZ = posZ + (Math.random() * 10 - 5);
        particle.setAttribute('animation', {
          property: 'position',
          to: `${toX} ${toY} ${toZ}`,
          dur: 5000 + Math.random() * 5000, 
          easing: 'easeInOutSine',
          dir: 'alternate',
          loop: true
        });

        // 透明度を変えて点滅させる
        const fadeDur = 1000 + Math.random() * 1000;
        particle.setAttribute('animation__fade', {
          property: 'material.opacity',
          from: 0.3,
          to: 1.0,
          dur: fadeDur,
          dir: 'alternate',
          loop: true
        });

        particle.setAttribute('look-at', '[gps-camera]');
        scene.appendChild(particle);
      }
  });
  
</script>